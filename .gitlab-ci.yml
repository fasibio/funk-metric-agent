
# # Unit and integration tests
# test:
#   stage: test
#   only:
#     - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
#     - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3}).*/
#   tags: 
#     - dockerfasibio
#   image: golang:1.12.8
#   script:
  #  - go test -mod=vendor -coverprofile=cov.out
  #  - go tool cover -func cov.out  
  # coverage: /^total:\t+\(statements\)\t+(\d+\.\d+)%/
  # artifacts: 
  #  paths: 
  #    - ./cov.out

# sonar upload
# uploadSonarqube: 
#   image: ciricihq/gitlab-sonar-scanner
#   stage: sonarqube
#   script:
#     - sonar-scanner -Dsonar.projectKey=${SONAR_NAME}${CI_COMMIT_REF_NAME} -Dsonar.sources=. -Dsonar.host.url=${SONAR_HOST} -Dsonar.login=$sonarqubelogin
#   only: 
#     - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
#     - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3}).*/
#   tags:
#     - dockerfasibio
#   artifacts: 
#     paths: 
#       - ./cov.out
 
# build binary
buildBin: 
   stage: buildBin
   only:
    - master
   tags:
     - dockerfasibio
   image: golang:1.12.8-alpine3.9
   script: 
     - GO111MODULE=on CGO_ENABLED=0 GOOS=linux go build -mod vendor -a -installsuffix cgo -o bin/funk_metric_agent_LINUX_${CI_PIPELINE_IID} .
   artifacts:
     paths:
       - bin/funk_metric_agent_LINUX_${CI_PIPELINE_IID}
variables:
   RAILS_ENV: test
   SONAR_NAME: fasibio_metric_agent_
   SONAR_HOST: https://sonar.server2.fasibio.de


push: 
  stage: pushBinToGithub
  variables: 
   DRONE_BUILD_EVENT: tag
   GITHUB_REPO_OWNER: fasibio
   GITHUB_REPO_NAME: ${CI_PROJECT_NAME}
   GITHUB_COMMIT_REF: refs/heads/0.0.${CI_PIPELINE_IID}
   PLUGIN_FILES: "bin/*"
  only:
    - master
  tags:
    - dockerfasibio
  image: socialengine/github-release
  script:
    - github-release release --user $GITHUB_REPO_OWNER --repo $GITHUB_REPO_NAME --tag $GITHUB_COMMIT_REF --name "Release 0.0.${CI_PIPELINE_IID}" --pre-release --file bin/funk_metric_agent_LINUX_${CI_PIPELINE_IID}
    # - touch bin/test123.txt
    # - echo "hallo" > bin/test123.txt
    # - ls -la bin
    # - pwd
    # - docker run --rm -e DRONE_BUILD_EVENT=tag -e DRONE_REPO_OWNER=fasibio -e DRONE_REPO_NAME=${CI_PROJECT_NAME} -e DRONE_COMMIT_REF=refs/heads/0.0.${CI_PIPELINE_IID} -e PLUGIN_API_KEY=${PLUGIN_API_KEY} -e PLUGIN_FILES="bin/*" -v $(pwd):$(pwd) -w $(pwd)  plugins/github-release
stages:

  # - test
  # - sonarqube
  - buildBin
  - pushBinToGithub
